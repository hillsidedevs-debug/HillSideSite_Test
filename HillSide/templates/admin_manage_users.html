{% extends "basic.html" %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">Manage Users ({{ pagination.total }} total)</h2>
  </div>
<!-- ==================== SEARCH BAR ==================== -->
    <div class="card border-0 shadow-sm rounded-4 mb-4">
        <div class="card-body">
            <form method="GET" action="{{ url_for('admin.manage_users') }}" class="row g-3 align-items-end">
                <div class="col-md-5">
                    <input type="text" name="q" class="form-control form-control-lg rounded-4"
                           placeholder="Search by username, email or name..."
                           value="{{ request.args.get('q', '') }}">
                </div>
                <!-- <div class="col-md-4">
                    <select name="role" class="form-select form-select-lg rounded-4">
                        <option value="">All Roles</option>
                        <option value="admin" {% if request.args.get('role') == 'admin' %}selected{% endif %}>Admin</option>
                        <option value="teacher" {% if request.args.get('role') == 'teacher' %}selected{% endif %}>Teacher</option>
                        <option value="staff" {% if request.args.get('role') == 'staff' %}selected{% endif %}>Staff</option>
                    </select>
                </div> -->
                <div class="col-md-3 d-grid">
                    <button type="submit" class="btn btn-primary btn-lg rounded-4">
                        <i class="bi bi-search me-2"></i> Search
                    </button>
                </div>
            </form>

            <!-- Result count & clear link -->
            {% if request.args.get('q') or request.args.get('role') %}
            <div class="mt-3">
                <small class="text-muted">
                    {% if users|length == 0 %}
                        <strong>No staff</strong> found
                    {% else %}
                        <strong>{{ users|length }}</strong> staff member{{ 's' if users|length != 1 else '' }}
                    {% endif %}
                    {% if request.args.get('q') or request.args.get('role') %}
                        matching your search
                        {% if request.args.get('q') %} for "<em>{{ request.args.get('q')|escape }}</em>"{% endif %}
                        {% if request.args.get('role') %} with role "<em>{{ request.args.get('role')|capitalize }}</em>"{% endif %}
                    {% endif %}
                    • <a href="{{ url_for('admin.manage_users') }}" class="text-decoration-none">Clear filters</a>
                </small>
            </div>
            {% endif %}
        </div>
    </div>
    <!-- ==================================================== -->
  <div class="card border-0 shadow-sm rounded-4">
    <div class="card-body">
      <table class="table align-middle table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Email</th>
            <th>Role</th>
            <th>Enrollments</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr>
            <td>{{ user.id }}</td>
            <td>
              <a href="{{ url_for('admin.user_details', user_id=user.id) }}"
                 class="text-decoration-none text-dark fw-semibold">
                {{ user.username }}
              </a>
            </td>
            <td>{{ user.email }}</td>
            <td>
              <span class="badge bg-{{ 'danger' if user.role.value == 'admin' else 'primary' if user.role.value == 'staff' else 'secondary' }}">
                {{ user.role.value.title() }}
              </span>
            </td>
            <td>{{ user.enrollments|length }}</td>
            <td>
              <a href="{{ url_for('admin.user_details', user_id=user.id) }}" class="btn btn-sm btn-outline-info me-2">
                  <i class="bi bi-eye"></i>
              </a>
              
              <!-- Delete trigger button -->
              <button type="button" class="btn btn-sm btn-outline-danger"
                      data-bs-toggle="modal" data-bs-target="#deleteModal{{ user.id }}">
                  <i class="bi bi-trash"></i>
              </button>
          </td>
          </tr>

                    <!-- Delete Modal for this user -->
          <div class="modal fade" id="deleteModal{{ user.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ user.id }}" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content border-0 shadow-sm rounded-4">
                      <div class="modal-header bg-danger text-white">
                          <h5 class="modal-title" id="deleteModalLabel{{ user.id }}">Delete User</h5>
                          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                          Are you sure you want to permanently delete <strong>{{ user.username }}</strong> 
                          ({{ user.email }})?<br>
                          <small class="text-muted">This will also remove their enrollments.</small>
                      </div>
                      <div class="modal-footer">
                          <button type="button" class="btn btn-secondary rounded-4" data-bs-dismiss="modal">Cancel</button>
                          
                          <form action="{{ url_for('admin.delete_user', user_id=user.id) }}" method="POST">
                              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                              <button type="submit" class="btn btn-danger rounded-4 px-3">Delete</button>
                          </form>
                      </div>
                  </div>
              </div>
          </div>
          {% else %}
          <tr>
              <td colspan="6" class="text-center text-muted py-5">
                  {% if request.args.get('q') or request.args.get('role') %}
                      No staff match your search.
                  {% else %}
                      No staff members yet.
                  {% endif %}
              </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Bootstrap 5 Pagination -->
    {% if pagination.pages > 1 %}
    <div class="card-footer bg-transparent border-0">
      <nav aria-label="Users pagination">
        <ul class="pagination justify-content-center mb-0">
          <!-- Previous -->
          <li class="page-item {{ 'disabled' if not pagination.has_prev else '' }}">
            <a class="page-link" href="{{ url_for('admin.manage_users', page=pagination.prev_num) }}"
               {% if not pagination.has_prev %}tabindex="-1" aria-disabled="true"{% endif %}>
              Previous
            </a>
          </li>

          <!-- Page numbers (smart range) -->
          {% for p in pagination.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
            {% if p %}
              {% if p == pagination.page %}
              <li class="page-item active"><a class="page-link" href="#">{{ p }}</a></li>
              {% else %}
              <li class="page-item"><a class="page-link" href="{{ url_for('admin.manage_users', page=p) }}">{{ p }}</a></li>
              {% endif %}
            {% else %}
              <li class="page-item disabled"><span class="page-link">…</span></li>
            {% endif %}
          {% endfor %}

          <!-- Next -->
          <li class="page-item {{ 'disabled' if not pagination.has_next else '' }}">
            <a class="page-link" href="{{ url_for('admin.manage_users', page=pagination.next_num) }}"
               {% if not pagination.has_next %}tabindex="-1" aria-disabled="true"{% endif %}>
              Next
            </a>
          </li>
        </ul>
      </nav>
      <div class="text-center text-muted small">
        Showing {{ pagination.items|length }} of {{ pagination.total }} users
        (Page {{ pagination.page }} of {{ pagination.pages }})
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}